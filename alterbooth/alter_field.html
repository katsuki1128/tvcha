<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”»é¢</title>

    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/reset.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

</head>

<body>
    <!----------------------------------------------
    â­ï¸ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢  
    ------------------------------------------------->

    <section class="bg-gray-200">

        <div class="flex flex-col items-center centered" style="z-index:2">
            <h2 class="text-xl font-semibold mb-2">ã‚¤ãƒ™ãƒ³ãƒˆç†±é‡</h2>
            <div id="userPoint" class="text-2xl font-bold userPoint"></div>
        </div>

    </section>

    <!-- â­ï¸ã‚¹ã‚¿ãƒ³ãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div
        style="position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; background-color: white;">
        <img src="img/geekersnight.png"
            style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; margin: auto; z-index: 1;">

        <canvas id="overlay" style="position: absolute; top: 0; left: 0; z-index: 3;"></canvas>
    </div>



    <script type="module">
        //----------------------------------------
        // â–¼firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨javaScriptã‚’é€£æºã•ã›ã‚‹
        //----------------------------------------

        // å¿…è¦ãªæ©Ÿèƒ½ã‚’SDKã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";


        // firebase firestoreã¨ã‚„ã‚Šå–ã‚Šã‚’ã™ã‚‹è¨­å®š
        import {
            getFirestore,
            collection,
            addDoc,
            serverTimestamp,
            query,
            orderBy, //ãƒ‡ãƒ¼ã‚¿ã®ã‚½ãƒ¼ãƒˆ
            onSnapshot, // Firestore ä¸Šã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            doc,
            deleteDoc,
            updateDoc,
            where,
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        // firebase storageã¨ã‚„ã‚Šå–ã‚Šã‚’ã™ã‚‹è¨­å®š
        import {
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";



        // ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®Firebaseã®è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBs-rcINsUSZe7bD7OeLTrNcXm6-OInABg",
            authDomain: "tvcha-9cae7.firebaseapp.com",
            projectId: "tvcha-9cae7",
            storageBucket: "tvcha-9cae7.appspot.com",
            messagingSenderId: "866848033597",
            appId: "1:866848033597:web:c6887382eb14ee58351354",
        };

        // Firebaseã®åˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);

        // Firebaseã‚¢ãƒ—ãƒªã¨Cloud Storageã®é€£æºã‚’åˆæœŸåŒ–ã—ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹
        const storage = getStorage(app);

        // dbã«å¯¾ã—ã¦ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ã‚„å–å¾—ãŒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        const db = getFirestore(app);

        // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®åå‰ã‚’å®šç¾©
        const collectionName = "alterbooth";
        const collectionUsernName = "alter-user";

        // ğŸ”½ ãƒ‡ãƒ¼ã‚¿å–å¾—æ¡ä»¶ã®æŒ‡å®šï¼ˆä»Šå›ã¯orderé †ã«ä¸¦ã³æ›¿ãˆã¦å–å¾—ï¼‰
        const q = query(collection(db, collectionName), orderBy("order", "desc"));

        // ğŸ”½ ãƒ‡ãƒ¼ã‚¿å–å¾—æ¡ä»¶ã®æŒ‡å®šï¼ˆä»Šå›ã¯orderé †ã«ä¸¦ã³æ›¿ãˆã¦å–å¾—ï¼‰
        const user_q = query(collection(db, collectionUsernName));

        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—ã®URLã‚’æ ¼ç´ã™ã‚‹é…åˆ—
        let clickStamp = "";
        const clickStamps = [];
        const canvas = document.getElementById('overlay');
        const ctx = canvas.getContext('2d');
        const stamps = []; // ã‚¹ã‚¿ãƒ³ãƒ—ã®æƒ…å ±ã‚’ä¿æŒã™ã‚‹é…åˆ—


        //----------------------------------------
        // â–¼ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’è¨­å®š
        //----------------------------------------

        // åˆæœŸã‚µã‚¤ã‚ºè¨­å®š
        updateCanvasSize();

        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ãƒªã‚µã‚¤ã‚ºã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–
        window.addEventListener('resize', updateCanvasSize);

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®å¤§ãã•ã«åˆã‚ã›ã¦è¨­å®š
        function updateCanvasSize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            // console.log(canvas.width, canvas.height)
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®å†æç”»ãªã©è¿½åŠ ã®å‡¦ç†ãŒå¿…è¦ãªå ´åˆã€ã“ã“ã§è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
        };

        // ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†(ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸Šã§ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ãŒç™ºç”Ÿã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ {} å†…ã®å‡¦ç†ã‚’å®Ÿè¡Œ)
        onSnapshot(q, (querySnapshot) => {

            querySnapshot.docChanges().forEach((change) => {
                if (change.type === "modified") {
                    // console.log("ã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
                    const clickStamp = change.doc.data().img;
                    // clickStamps.push(clickStamp);
                    // console.log("ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—é…åˆ—", clickStamps);
                    // console.log("ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—", clickStamp);
                    // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ãŸå¾Œã€2ç§’å¾Œã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹
                    // setTimeout(() => {
                    drawImageOnCanvas(clickStamp);
                    // console.log(clickStamp);
                    // }, 1000);
                }
            });
        });

        //----------------------------------------
        // â–¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒã‚¤ãƒ³ãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        //----------------------------------------
        // æœ€åˆã«ãƒªã‚¹ãƒŠãƒ¼ã‚’å¤‰æ•°ã«æ ¼ç´
        const arrayUser = []; // arrayUserã‚’åˆæœŸåŒ–ã—ã¦ãŠã
        onSnapshot(user_q, (querySnapshot) => {
            arrayUser.length = 0; // é…åˆ—ã‚’ã‚¯ãƒªã‚¢ã—ã¦æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ 

            querySnapshot.docs.forEach(function (doc) {
                const document = {
                    id: doc.id,
                    data: doc.data(),
                };
                arrayUser.push(document);
            });

            // console.log("arrayUser", arrayUser)
            // console.log("userHavePoint:", arrayUser[1].data.point);

            const userPointElement = document.getElementById('userPoint');
            if (userPointElement) {
                userPointElement.textContent = arrayUser[0].data.point;
                // console.log(userPointElement);
            }
        });

        //----------------------------------------
        // â–¼åŸºæœ¬ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®š
        //----------------------------------------
        // const targetX = (canvas.width) / 2// ç”»é¢ä¸­å¤®ã®Xåº§æ¨™
        const targetX = Math.random() * canvas.width;
        // const variance = canvas.width / 40;  // ã“ã‚Œã¯ã©ã‚Œãã‚‰ã„å¤‰å‹•ã™ã‚‹ã‹ã®ç¯„å›²ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã“ã®å ´åˆã€ç”»é¢ã®1/4ã®ç¯„å›²ã§å¤‰å‹•ã—ã¾ã™ã€‚
        // const targetX = canvas.width / 2 + (Math.random() - 0.5) * 2 * canvas.width / 40;  // ç”»é¢ä¸­å¤®ã®Xåº§æ¨™ã‚’åŸºç‚¹ã«ãƒ©ãƒ³ãƒ€ãƒ ãªå€¤ã‚’åŠ ãˆã‚‹

        const targetY = (canvas.height) / 2; // ç”»é¢ä¸­å¤®ã®Yåº§æ¨™
        const maxSize = 500; // æœ€å¤§ã‚µã‚¤ã‚º
        let friction = 0.95; // æ‘©æ“¦ä¿‚æ•°
        const initialGrowthRate = 2; // åˆæœŸã®æˆé•·ç‡

        //----------------------------------------
        // â–¼æ‘©æ“¦ä¿‚æ•°
        //----------------------------------------

        //----------------------------------------
        // â–¼ã‚¹ã‚¿ãƒ³ãƒ—æç”»é–¢æ•°
        //----------------------------------------
        let isAnimationRunning = false;

        // clickStampãŒæ›´æ–°ã•ã‚ŒãŸã‚‰æç”»ã™ã‚‹ãŸã‚ã®é–¢æ•°
        function drawImageOnCanvas(stampURL) {

            const image = document.createElement('img');
            image.onload = function () {
                //----------------------------------------
                // â–¼ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é…åˆ—ã«å…¥ã‚Œã‚‹
                //----------------------------------------

                let posX, posY, velocityX;

                if (Math.random() < 0.5) {
                    posX = 0;
                    // velocityX = 10;

                    const velocities = [10, 20, 40, 60, 0];
                    const randomIndex = Math.floor(Math.random() * velocities.length);
                    velocityX = velocities[randomIndex];


                    posY = Math.random() * canvas.height / 4 * 3;
                }
                else {
                    posX = canvas.width;
                    // ãƒ©ãƒ³ãƒ€ãƒ ãªé€Ÿåº¦ã‚’è¨­å®š

                    const velocities = [-30, -50, -70, -90, -110];
                    const randomIndex = Math.floor(Math.random() * velocities.length);
                    velocityX = velocities[randomIndex];
                    // velocityX = -45;


                    posY = Math.random() * canvas.height / 4 * 3;
                }

                console.log(velocityX)
                const stampInfo = {
                    image: image,
                    posX: posX,
                    posY: posY,
                    velocityX: velocityX,
                    velocityY: 0,
                    size: 0,
                    alpha: 1.0,
                    isAnimating: true,
                };
                stamps.push(stampInfo);
                // console.log(stamps)

                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
                if (!isAnimationRunning) {
                    isAnimationRunning = true;
                    animate();
                }
            };
            image.src = stampURL; // clickStampsã«ç”»åƒã®URLã‚’æ ¼ç´
        };
        //----------------------------------------
        // â–¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é–¢æ•°
        //----------------------------------------

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
        // animate();

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Canvasã‚’ã‚¯ãƒªã‚¢

            // é€Ÿåº¦ã‚’æ›´æ–°
            for (let i = 0; i < stamps.length; i++) {
                const stamp = stamps[i];

                if (stamp.isAnimating) {
                    stamp.velocityX *= friction; // æ‘©æ“¦ã‚’é©ç”¨
                    stamp.velocityY *= friction; // æ‘©æ“¦ã‚’é©ç”¨
                    // console.log("èª­ã¿è¾¼ã¿")
                    // ä½ç½®ã‚’æ›´æ–°
                    stamp.posX += stamp.velocityX; // é€Ÿåº¦ã«ã‚ˆã‚‹ä½ç½®ã®å¤‰åŒ–
                    stamp.posY += stamp.velocityY; // é€Ÿåº¦ã«ã‚ˆã‚‹ä½ç½®ã®å¤‰åŒ–

                    // ã‚µã‚¤ã‚ºã‚’æ›´æ–°
                    const distanceToTarget = Math.sqrt((targetX - stamp.posX) ** 2 + (targetY - stamp.posY) ** 2);
                    const growthRate = initialGrowthRate * (1 + distanceToTarget / canvas.width); // è·é›¢ã«å¿œã˜ã¦æˆé•·ç‡ã‚’èª¿æ•´

                    // ã‚µã‚¤ã‚ºã‚’æ›´æ–°
                    if (stamp.size < 450) {
                        stamp.size += growthRate; // æˆé•·ç‡ã«ã‚ˆã‚‹ã‚µã‚¤ã‚ºã®å¢—åŠ 
                    } else if (stamp.size >= 450 && stamp.size < maxSize) {
                        stamp.size += growthRate; // 400ã‹ã‚‰500ã®é–“ã‚‚æˆé•·ã‚’ç¶šã‘ã‚‹
                        stamp.alpha -= 0.05; // é€æ˜åº¦ã‚’ä¸‹ã’ã‚‹
                    }
                    ctx.globalAlpha = stamp.alpha;

                    // ã‚¹ã‚¿ãƒ³ãƒ—ã®ä¸­å¤®åº§æ¨™ã‚’è¨ˆç®—
                    const centerX = stamp.posX + stamp.size / 2;
                    const centerY = stamp.posY + stamp.size / 2;

                    // ã‚¹ã‚¿ãƒ³ãƒ—ã®ä¸­å¤®åº§æ¨™ã‚’ä¸­å¿ƒã«æç”»
                    ctx.drawImage(stamp.image, centerX - stamp.size / 2, centerY - stamp.size / 2, stamp.size, stamp.size);

                    if (stamp.alpha <= 0 || stamp.size > 500) {
                        stamp.alpha = 0; // é€æ˜åº¦ãŒ-10ã®ã¾ã¾ã‚­ãƒ¼ãƒ—ã™ã‚‹
                        // stamps.shift(); // é…åˆ—ã®å…ˆé ­ã‹ã‚‰å‰Šé™¤
                        // console.log(stamp.size, stamp.alpha)
                        // console.log("é…åˆ—ã®å…ˆé ­ã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ", stamps);

                        stamp.isAnimating = false;
                    };
                };
            }
            if (stamps.length > 0) {
                requestAnimationFrame(animate);
            }
        };
    </script>
</body>

</html>