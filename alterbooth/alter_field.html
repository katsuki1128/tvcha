<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”»é¢</title>

    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/reset.css">

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

</head>

<body>
    <!-- â­ï¸ã‚¹ã‚¿ãƒ³ãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div
        style="position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; background-color: white;">
        <img src="img/geekersnight.png"
            style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; margin: auto; z-index: 1;">
        <canvas id="overlay" width="1400" height="800"
            style="position: absolute; top: 0; left: 0; z-index: 2;"></canvas>
    </div>

    <script type="module">
        //----------------------------------------
        // â–¼firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨javaScriptã‚’é€£æºã•ã›ã‚‹
        //----------------------------------------

        // å¿…è¦ãªæ©Ÿèƒ½ã‚’SDKã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";


        // firebase firestoreã¨ã‚„ã‚Šå–ã‚Šã‚’ã™ã‚‹è¨­å®š
        import {
            getFirestore,
            collection,
            addDoc,
            serverTimestamp,
            query,
            orderBy, //ãƒ‡ãƒ¼ã‚¿ã®ã‚½ãƒ¼ãƒˆ
            onSnapshot, // Firestore ä¸Šã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            doc,
            deleteDoc,
            updateDoc,
            where,
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        // firebase storageã¨ã‚„ã‚Šå–ã‚Šã‚’ã™ã‚‹è¨­å®š
        import {
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";



        // ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®Firebaseã®è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBs-rcINsUSZe7bD7OeLTrNcXm6-OInABg",
            authDomain: "tvcha-9cae7.firebaseapp.com",
            projectId: "tvcha-9cae7",
            storageBucket: "tvcha-9cae7.appspot.com",
            messagingSenderId: "866848033597",
            appId: "1:866848033597:web:c6887382eb14ee58351354",
        };

        // Firebaseã®åˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);

        // Firebaseã‚¢ãƒ—ãƒªã¨Cloud Storageã®é€£æºã‚’åˆæœŸåŒ–ã—ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹
        const storage = getStorage(app);

        // dbã«å¯¾ã—ã¦ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ã‚„å–å¾—ãŒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        const db = getFirestore(app);

        // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®åå‰ã‚’å®šç¾©
        const collectionName = "alterbooth";

        // ğŸ”½ ãƒ‡ãƒ¼ã‚¿å–å¾—æ¡ä»¶ã®æŒ‡å®šï¼ˆä»Šå›ã¯orderé †ã«ä¸¦ã³æ›¿ãˆã¦å–å¾—ï¼‰
        const q = query(collection(db, collectionName), orderBy("order", "desc"));

        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—ã®URLã‚’æ ¼ç´ã™ã‚‹é…åˆ—
        let clickStamp = "";
        const clickStamps = [];
        const canvas = document.getElementById('overlay');

        const ctx = canvas.getContext('2d');
        const stamps = []; // ã‚¹ã‚¿ãƒ³ãƒ—ã®æƒ…å ±ã‚’ä¿æŒã™ã‚‹é…åˆ—

        // console.log("stamps", stamps);

        // ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†(ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸Šã§ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ãŒç™ºç”Ÿã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ {} å†…ã®å‡¦ç†ã‚’å®Ÿè¡Œ)
        onSnapshot(q, (querySnapshot) => {
            // const documents = [];

            // querySnapshot.docs.forEach(function (doc) { //docsã¯é…åˆ— docã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
            //     const document = {
            //         id: doc.id, //ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID
            //         data: doc.data(), //ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®é…åˆ—ãƒ‡ãƒ¼ã‚¿
            //     };
            //     documents.push(document); //é…åˆ—ã®å…ˆé ­ã«è¿½åŠ  
            // });
            // console.log("documents", documents);

            querySnapshot.docChanges().forEach((change) => {
                if (change.type === "modified") {
                    // console.log("ã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
                    const clickStamp = change.doc.data().img;
                    clickStamps.push(clickStamp);
                    // console.log("ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—é…åˆ—", clickStamps);
                    console.log("ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—", clickStamp);
                    drawImageOnCanvas(); // ç”»åƒã‚’Canvasä¸Šã«æç”»
                }

            });

            // const countData = []; // countDataã‚’åˆæœŸåŒ–ã—ã¦ãŠã
            // const imageUrls = []; // imageUrlsã‚’åˆæœŸåŒ–ã—ã¦ãŠã


            //----------------------------------------
            // id: 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ID',
            // data: {
            //      img: 'ç”»åƒã®URL',
            //      point: 'ãƒã‚¤ãƒ³ãƒˆ',
            //      count: 'ã‚«ã‚¦ãƒ³ãƒˆ',
            //      time: 'ä½œæˆæ—¥æ™‚ãªã©'
            //      clickStamps: 'ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—ã®URLé…åˆ—'
            // countData : 'ã‚«ã‚¦ãƒ³ãƒˆã®é…åˆ—',
            // imageUrls : 'ç”»åƒã®URLã®é…åˆ—'
            //----------------------------------------

            //----------------------------------------
            // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦countDataã¨imageUrlsã‚’ä½œæˆ
            //----------------------------------------
            // documents.forEach((document, index) => {
            //     const {
            //         count,
            //         img
            //     } = document.data;
            //     countData.push(count);
            //     imageUrls.push(img);
            // });

            //----------------------------------------
            // â–¼ã‚¹ã‚¿ãƒ³ãƒ—æç”»é–¢æ•°
            //----------------------------------------

            // clickStampãŒæ›´æ–°ã•ã‚ŒãŸã‚‰æç”»ã™ã‚‹ãŸã‚ã®é–¢æ•°
            function drawImageOnCanvas() {

                const image = document.createElement('img');
                // console.log(image)
                image.onload = function () {
                    //----------------------------------------
                    // â–¼ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é…åˆ—ã«å…¥ã‚Œã‚‹
                    //----------------------------------------
                    const targetX = (canvas.width) / 4 - 100// ç”»é¢ä¸­å¤®ã®Xåº§æ¨™
                    const targetY = (canvas.height) / 3 * 2 + 100; // ç”»é¢ä¸­å¤®ã®Yåº§æ¨™
                    // console.log(targetX, targetY);

                    let posX = 0; // åˆæœŸä½ç½®ã‚’Canvasã®å·¦ç«¯ã«è¨­å®š
                    let posY = canvas.height / 3 * 1; // åˆæœŸä½ç½®ã‚’Canvasã®ä¸­å¤®ã«è¨­å®š
                    let velocityX = 45; // Xè»¸æ–¹å‘ã®é€Ÿåº¦
                    let velocityY = 0; // Yè»¸æ–¹å‘ã®é€Ÿåº¦

                    let size = 0; // åˆæœŸã‚µã‚¤ã‚º
                    const maxSize = 500; // æœ€å¤§ã‚µã‚¤ã‚º
                    const growthRate = 2; // ã‚µã‚¤ã‚ºã®æˆé•·ç‡


                    const friction = 0.95; // æ‘©æ“¦ä¿‚æ•°

                    let alpha = 1.0; // é€æ˜åº¦
                    let isAnimating = true; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç¶™ç¶šãƒ•ãƒ©ã‚°

                    //----------------------------------------
                    // â–¼ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é…åˆ—ã«å…¥ã‚Œã‚‹
                    //----------------------------------------

                    const stampInfo = {
                        image: image,
                        posX: posX,
                        posY: posY,
                        velocityX: velocityX,
                        velocityY: velocityY,
                        size: size,
                        alpha: alpha,
                        isAnimating: isAnimating,
                    };
                    // console.log("stampInfo", stampInfo);
                    stamps.push(stampInfo);

                    // console.log("stamps", stamps);

                    //----------------------------------------
                    // â–¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é–¢æ•°
                    //----------------------------------------

                    function animate() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height); // Canvasã‚’ã‚¯ãƒªã‚¢

                        // é€Ÿåº¦ã‚’æ›´æ–°
                        for (let i = 0; i < stamps.length; i++) {

                            const stamp = stamps[i];

                            stamp.velocityX *= friction; // æ‘©æ“¦ã‚’é©ç”¨
                            stamp.velocityY *= friction; // æ‘©æ“¦ã‚’é©ç”¨

                            // ä½ç½®ã‚’æ›´æ–°
                            stamp.posX += stamp.velocityX; // é€Ÿåº¦ã«ã‚ˆã‚‹ä½ç½®ã®å¤‰åŒ–
                            stamp.posY += stamp.velocityY; // é€Ÿåº¦ã«ã‚ˆã‚‹ä½ç½®ã®å¤‰åŒ–
                            // console.log(i, stamp.posX);
                            // ã‚µã‚¤ã‚ºã‚’æ›´æ–°
                            if (stamp.size < 450) {
                                stamp.size += growthRate; // æˆé•·ç‡ã«ã‚ˆã‚‹ã‚µã‚¤ã‚ºã®å¢—åŠ 
                            } else if (stamp.size >= 400 && stamp.size < maxSize) {
                                stamp.size += growthRate; // 400ã‹ã‚‰500ã®é–“ã‚‚æˆé•·ã‚’ç¶šã‘ã‚‹
                                stamp.alpha -= 0.05; // é€æ˜åº¦ã‚’ä¸‹ã’ã‚‹
                            }
                            // console.log(stamp.alpha);
                            // console.log(stamp.size);
                            if (stamp.alpha <= 0) {
                                stamp.alpha = 0; // é€æ˜åº¦ãŒ0ã®ã¾ã¾ã‚­ãƒ¼ãƒ—ã™ã‚‹
                                stamps.shift(); // é…åˆ—ã®å…ˆé ­ã‹ã‚‰å‰Šé™¤
                                // console.log("stamps", stamps);
                            }

                            ctx.globalAlpha = stamp.alpha; // é€æ˜åº¦ã‚’é©ç”¨
                            ctx.drawImage(stamp.image, stamp.posX, stamp.posY, stamp.size, stamp.size);
                            ctx.globalAlpha = 1.0; // é€æ˜åº¦ã‚’å…ƒã«æˆ»ã™


                            // console.log("stamps", stamps);

                            // ç›®æ¨™ä½ç½®ã«è¿‘ã¥ã„ãŸã‚‰é€Ÿåº¦ã‚’ã‚¼ãƒ­ã«ã™ã‚‹
                            if (Math.abs(stamp.posX - targetX) < 1 && Math.abs(stamp.posY - targetY) < 1) {
                                stamp.velocityX = 0;
                                stamp.velocityY = 0;
                                stamp.isAnimating = false;
                            }
                            else if (stamp.isAnimating) {
                                requestAnimationFrame(animate);
                            }
                        }
                    };
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
                    animate();
                };
                image.src = clickStamps[clickStamps.length - 1]; // clickStampsã«ç”»åƒã®URLãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹ã¨ä»®å®šã—ã¦ã„ã¾ã™
                // console.log(image.src)
            };

            // function drawImageOnCanvas() {

            //     const image = new Image();
            //     image.onload = function () {
            //         let posX = 0; // åˆæœŸä½ç½®ã‚’Canvasã®å·¦ç«¯ã«è¨­å®š
            //         let posY = canvas.height / 2; // åˆæœŸä½ç½®ã‚’Canvasã®åº•è¾ºã«è¨­å®š

            //         // let velocityY = 2; // åˆé€Ÿåº¦ã‚’è¨­å®šï¼ˆä¸‹å‘ãã®ãŸã‚è² ã®å€¤ï¼‰
            //         // const gravity = 0.1; // é‡åŠ›ã®å½±éŸ¿ã‚’è¡¨ã™å®šæ•°

            //         let velocityX = 2; // Xæ–¹å‘ã®é€Ÿåº¦ã‚’è¨­å®š
            //         const targetX = canvas.width / 2; // ç›®æ¨™ä½ç½®ã‚’Canvasã®ä¸­å¤®ã«è¨­å®š

            //         function animate() {

            //             ctx.clearRect(0, 0, canvas.width, canvas.height); // Canvasã‚’ã‚¯ãƒªã‚¢

            //             // ä½ç½®ã‚’æ›´æ–°
            //             if (posX < targetX) {
            //                 posX += velocityX; // é€Ÿåº¦ã«ã‚ˆã‚‹ä½ç½®ã®å¤‰åŒ–
            //             }

            //             // ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æç”»
            //             ctx.drawImage(image, posX, posY, 100, 100);

            //             if (posX < targetX) {
            //                 requestAnimationFrame(animate);
            //             }
            //             //     // ä½ç½®ã‚’æ›´æ–°
            //             //     // posX += 30; // é€Ÿåº¦ã«ã‚ˆã‚‹ä½ç½®ã®å¤‰åŒ–
            //             //     posX += 2; // é€Ÿåº¦ã«ã‚ˆã‚‹ä½ç½®ã®å¤‰åŒ–
            //             //     velocityY += gravity; // é‡åŠ›ã«ã‚ˆã‚‹é€Ÿåº¦ã®å¢—åŠ 
            //             //     posY += velocityY; // é€Ÿåº¦ã«ã‚ˆã‚‹ä½ç½®ã®å¤‰åŒ–

            //             //     // ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æç”»
            //             //     ctx.drawImage(image, posX, posY, 100, 100);
            //             //     requestAnimationFrame(animate);
            //         }

            //         // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
            //         animate();
            //     };
            //     image.src = clickStamps[clickStamps.length - 1]; // clickStampsã«ç”»åƒã®URLãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹ã¨ä»®å®šã—ã¦ã„ã¾ã™
            // }

            // }
        });

        // unsubscribe();

    </script>
</body>

</html>