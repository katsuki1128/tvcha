<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>„Çπ„Çø„É≥„Éó‰ΩúÊàêÁîªÈù¢</title>

    <!-- CSS & Tailwind -->
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="reset.css" />

    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/flowbite@1.4.4/dist/flowbite.min.css"
    />

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

  </head>

  <body>
    <!----------------------------------------------
    ‚≠êÔ∏è„Çπ„Çø„É≥„ÉóË°®Á§∫„Ç®„É™„Ç¢  
    ------------------------------------------------->
    <section class="bg-gray-200">
      <div
        class="flex flex-col items-center justify-center px-6 pt-8 pb-4 mx-auto"
      >
        <div
          class="w-full bg-white rounded-lg shadow sm:max-w-3xl md:w-4/5 xl:p-0"
        >
          <div class="p-6 space-y-4 md:space-y-6 sm:p-8">
            <div>
              <a href="./index.html">
              <img
                class="w-40 h-15 mr-2"
                src="./img/tvcha_logo.png"
                alt="logo"
              />
              </a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div id="stampListContainer" class="container"></div>
    <!-- ‚≠êÔ∏è„Çπ„Çø„É≥„Éó‰∏ÄË¶ßË°®Á§∫„Ç®„É™„Ç¢ -->
    <section class="bg-gray-200">
      <div
        class="flex flex-col items-center justify-center px-6 pt-4 pb-4 mx-auto"
      >
        

      </div>
    </section>

    <script type="module">
      //----------------------------------------
      // ‚ñºfirebase„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å®javaScript„ÇíÈÄ£Êê∫„Åï„Åõ„Çã
      //----------------------------------------

      // ÂøÖË¶Å„Å™Ê©üËÉΩ„ÇíSDK„Åã„Çâ„Ç§„É≥„Éù„Éº„Éà
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";

      // firebase firestore„Å®„ÇÑ„ÇäÂèñ„Çä„Çí„Åô„ÇãË®≠ÂÆö
      import {
        getFirestore,
        collection,
        addDoc,
        serverTimestamp,
        query,
        orderBy, //„Éá„Éº„Çø„ÅÆ„ÇΩ„Éº„Éà
        onSnapshot, // Firestore ‰∏ä„Å´‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Çã„Éá„Éº„Çø„ÇíÂèñÂæó
        doc,
        deleteDoc,
        updateDoc,
        getDocs,
        getDoc,
        increment
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

      // firebase storage„Å®„ÇÑ„ÇäÂèñ„Çä„Çí„Åô„ÇãË®≠ÂÆö
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

      // „Ç¶„Çß„Éñ„Ç¢„Éó„É™„ÅÆFirebase„ÅÆË®≠ÂÆö
      const firebaseConfig = {
        apiKey: "AIzaSyBs-rcINsUSZe7bD7OeLTrNcXm6-OInABg",
        authDomain: "tvcha-9cae7.firebaseapp.com",
        projectId: "tvcha-9cae7",
        storageBucket: "tvcha-9cae7.appspot.com",
        messagingSenderId: "866848033597",
        appId: "1:866848033597:web:c6887382eb14ee58351354",
      };

      // Firebase„ÅÆÂàùÊúüÂåñ
      const app = initializeApp(firebaseConfig);

      // Firebase„Ç¢„Éó„É™„Å®Cloud Storage„ÅÆÈÄ£Êê∫„ÇíÂàùÊúüÂåñ„Åó„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„Åô„Çã
      const storage = getStorage(app);

      // db„Å´ÂØæ„Åó„Å¶„Éá„Éº„Çø„ÅÆËøΩÂä†„ÇÑÂèñÂæó„Åå„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åô„Çã
      const db = getFirestore(app);

      // üîΩ „Éá„Éº„ÇøÂèñÂæóÊù°‰ª∂„ÅÆÊåáÂÆöÔºà‰ªäÂõû„ÅØorderÈ†Ü„Å´‰∏¶„Å≥Êõø„Åà„Å¶ÂèñÂæóÔºâ
      const q = query(collection(db, "tvcha"), orderBy("order", "desc"));

      //----------------------------------------
      // ‚ñº„Çπ„Çø„É≥„Éó„ÇØ„É™„ÉÉ„ÇØÈñ¢Êï∞
      //----------------------------------------

      function handleItemClick(documentId) {
        // Firestore„ÅÆ„Éâ„Ç≠„É•„É°„É≥„ÉàÂèÇÁÖß„Çí‰ΩúÊàê
        const docRef = doc(db, "tvcha", documentId);

        // „Éá„Éº„Çø„ÇíÊõ¥Êñ∞„Åô„Çã
        updateDoc(docRef, {
          count: increment(1),
        });
      }

      //----------------------------------------
      // ‚ñºÂ§âÊõ¥„Éú„Çø„É≥Èñ¢Êï∞
      //----------------------------------------

      // ÁîªÂÉè„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ URL „ÇíÂèñÂæó„Åó„Å¶Ë°®Á§∫„Åô„Çã„Åü„ÇÅ„ÅÆÈñ¢Êï∞
      function displayImage(downloadURL, element) {
        // „Åô„Åß„Å´ÁîªÂÉè„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÂâäÈô§„Åô„Çã
        while (element.firstChild) {
          element.removeChild(element.firstChild);
        }

        // Êñ∞„Åó„ÅÑÁîªÂÉè„ÇíË°®Á§∫
        const img = document.createElement("img");
        img.src = downloadURL;
        element.appendChild(img);
      }


      

      // „Éá„Éº„ÇøÂèñÂæóÂá¶ÁêÜ(„Éá„Éº„Çø„Éô„Éº„Çπ‰∏ä„Åß„Éá„Éº„Çø„ÅÆÂ§âÊõ¥„ÅåÁô∫Áîü„Åó„Åü„Çø„Ç§„Éü„É≥„Ç∞„Åß {} ÂÜÖ„ÅÆÂá¶ÁêÜ„ÇíÂÆüË°å)
      onSnapshot(q, (querySnapshot) => {
        const array = [];
        querySnapshot.docs.forEach(function (doc) {
          const document = {
            id: doc.id,
            data: doc.data(),
          };
          array.push(document);
        });   

        const imageUrls = []; // imageUrls„ÇíÂàùÊúüÂåñ„Åó„Å¶„Åä„Åè
        const pointData = []; // pointData„ÇíÂàùÊúüÂåñ„Åó„Å¶„Åä„Åè
        const countData = []; // countData„ÇíÂàùÊúüÂåñ„Åó„Å¶„Åä„Åè
        //----------------------------------------
        // id: '„Éâ„Ç≠„É•„É°„É≥„Éà„ÅÆID',
        // data: {
        //      img: 'ÁîªÂÉè„ÅÆURL',
        //      point: '„Éù„Ç§„É≥„Éà',
        //      count: '„Ç´„Ç¶„É≥„Éà',
        //      time: '‰ΩúÊàêÊó•ÊôÇ„Å™„Å©'
        // countData : '„Ç´„Ç¶„É≥„Éà„ÅÆÈÖçÂàó',
        // imageUrls : 'ÁîªÂÉè„ÅÆURL„ÅÆÈÖçÂàó'
        //----------------------------------------


        array.forEach(function (document, index) {
          
          // countData„Å´document.data.count„ÇíËøΩÂä†
          pointData.push(document.data.point);
          
          // countData„Å´document.data.count„ÇíËøΩÂä†
          countData.push(document.data.count);

          // imageUrls„Å´document.data.img„ÇíËøΩÂä†
          imageUrls.push(document.data.img);

        });

        //----------------------------------------
        // ‚ñº„Çπ„Çø„É≥„Éó„ÇíË°®Á§∫„Åô„ÇãÈñ¢Êï∞
        //----------------------------------------
        const stampListContainer = document.getElementById('stampListContainer');

        function renderImages() {
            stampListContainer.innerHTML = '';          

            imageUrls.forEach((imageUrl, index) => {
              const imageWrapper = document.createElement('div');
              imageWrapper.className = 'image-wrapper';
              
              const imageElement = document.createElement('img');
              imageElement.src = imageUrl;
              imageElement.className = 'image';
              
              // „Çπ„Çø„É≥„Éó„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„Å®„Åç„Å´handleStampClickÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åô
              imageElement.addEventListener('click', () => handleItemClick(array[index].id));
              
              imageWrapper.appendChild(imageElement);
              
              const pointElement = document.createElement('div');
              pointElement.textContent = `${pointData[index]}`;
              pointElement.className = 'point';
              imageWrapper.appendChild(pointElement);
              
              stampListContainer.appendChild(imageWrapper);
            });
    
          }

        renderImages();
        

        
     
      });
      // console.log("pointData", pointData);
      console.log("countData", countData);
      console.log(imageUrls);

      

    </script>
  </body>
</html>
