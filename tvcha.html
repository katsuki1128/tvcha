<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã‚¹ã‚¿ãƒ³ãƒ—ä½œæˆç”»é¢</title>

    <!-- CSS & Tailwind -->
    <link rel="stylesheet" href="reset.css" />
    <link rel="stylesheet" href="style.css" />


    <script src="https://cdn.tailwindcss.com"></script>

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

  </head>

  <body>
    <!----------------------------------------------
    â­ï¸ã‚¹ã‚¿ãƒ³ãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢  
    ------------------------------------------------->
    <section class="bg-gray-200">
      <div
        class="flex flex-col items-center justify-center px-6 pt-8 pb-4 mx-auto"
      >
        <div
          class="w-full bg-white rounded-lg shadow sm:max-w-3xl md:w-4/5 xl:p-0"
        >
          <div class="p-6 space-y-4 md:space-y-6 sm:p-8">
            <div>
              <a href="./index.html">
              <img
                class="w-40 h-15 mr-2"
                src="./img/tvcha_logo.png"
                alt="logo"
              />
              </a>
            </div>
          </div>
        </div>
      </div>
    </section>


    <!-- â­ï¸åŒæ™‚é…ä¿¡ã‚¤ãƒ¡ãƒ¼ã‚¸ -->
    <!-- <iframe src="tv_overlay.html" width="720" height="480"></iframe> -->
  <div id="stampWrapper">
    <div id="stampListContainer" class="stampContainer"></div>
  </div>
    <!-- â­ï¸ã‚¹ã‚¿ãƒ³ãƒ—ä¸€è¦§è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <section class="bg-gray-200">
      <div
        class="flex flex-col items-center justify-center px-6 pt-4 pb-4 mx-auto"
      >
      </div>
    </section>
    <a href="./tv_overlay.html">â†’tv</a>
    <script type="module">
      //----------------------------------------
      // â–¼firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨javaScriptã‚’é€£æºã•ã›ã‚‹
      //----------------------------------------

      // å¿…è¦ãªæ©Ÿèƒ½ã‚’SDKã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";

      // firebase firestoreã¨ã‚„ã‚Šå–ã‚Šã‚’ã™ã‚‹è¨­å®š
      import {
        getFirestore,
        collection,
        addDoc,
        serverTimestamp,
        query,
        orderBy, //ãƒ‡ãƒ¼ã‚¿ã®ã‚½ãƒ¼ãƒˆ
        onSnapshot, // Firestore ä¸Šã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        doc,
        deleteDoc,
        updateDoc,
        getDocs,
        getDoc,
        increment
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

      // firebase storageã¨ã‚„ã‚Šå–ã‚Šã‚’ã™ã‚‹è¨­å®š
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

      // ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®Firebaseã®è¨­å®š
      const firebaseConfig = {
        apiKey: "AIzaSyBs-rcINsUSZe7bD7OeLTrNcXm6-OInABg",
        authDomain: "tvcha-9cae7.firebaseapp.com",
        projectId: "tvcha-9cae7",
        storageBucket: "tvcha-9cae7.appspot.com",
        messagingSenderId: "866848033597",
        appId: "1:866848033597:web:c6887382eb14ee58351354",
      };

      // Firebaseã®åˆæœŸåŒ–
      const app = initializeApp(firebaseConfig);

      // Firebaseã‚¢ãƒ—ãƒªã¨Cloud Storageã®é€£æºã‚’åˆæœŸåŒ–ã—ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹
      const storage = getStorage(app);

      // dbã«å¯¾ã—ã¦ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ã‚„å–å¾—ãŒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
      const db = getFirestore(app);

      // ğŸ”½ ãƒ‡ãƒ¼ã‚¿å–å¾—æ¡ä»¶ã®æŒ‡å®šï¼ˆä»Šå›ã¯orderé †ã«ä¸¦ã³æ›¿ãˆã¦å–å¾—ï¼‰
      const q = query(collection(db, "tvcha"), orderBy("order", "asc"));

      //----------------------------------------
      // â–¼ã‚¹ã‚¿ãƒ³ãƒ—ã‚¯ãƒªãƒƒã‚¯é–¢æ•°
      //----------------------------------------

      function handleItemClick(documentId) {
        // Firestoreã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§ã‚’ä½œæˆ
        const docRef = doc(db, "tvcha", documentId);

        // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã™ã‚‹
        updateDoc(docRef, {
          count: increment(1),
        });
      }

      //----------------------------------------
      // â–¼å¤‰æ›´ãƒœã‚¿ãƒ³é–¢æ•°
      //----------------------------------------

      // ç”»åƒã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ URL ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹ãŸã‚ã®é–¢æ•°
      function displayImage(downloadURL, element) {
        // ã™ã§ã«ç”»åƒãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤ã™ã‚‹
        while (element.firstChild) {
          element.removeChild(element.firstChild);
        }

        // æ–°ã—ã„ç”»åƒã‚’è¡¨ç¤º
        const img = document.createElement("img");
        img.src = downloadURL;
        element.appendChild(img);
      }

      // ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†(ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸Šã§ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ãŒç™ºç”Ÿã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ {} å†…ã®å‡¦ç†ã‚’å®Ÿè¡Œ)
      onSnapshot(q, (querySnapshot) => {
        const array = [];
        querySnapshot.docs.forEach(function (doc) {
          const document = {
            id: doc.id,
            data: doc.data(),
          };
          array.push(document);
        });   

        const imageUrls = []; // imageUrlsã‚’åˆæœŸåŒ–ã—ã¦ãŠã
        const pointData = []; // pointDataã‚’åˆæœŸåŒ–ã—ã¦ãŠã
        const countData = []; // countDataã‚’åˆæœŸåŒ–ã—ã¦ãŠã
        //----------------------------------------
        // id: 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ID',
        // data: {
        //      img: 'ç”»åƒã®URL',
        //      point: 'ãƒã‚¤ãƒ³ãƒˆ',
        //      count: 'ã‚«ã‚¦ãƒ³ãƒˆ',
        //      time: 'ä½œæˆæ—¥æ™‚ãªã©'
        // countData : 'ã‚«ã‚¦ãƒ³ãƒˆã®é…åˆ—',
        // imageUrls : 'ç”»åƒã®URLã®é…åˆ—'
        //----------------------------------------


        array.forEach(function (document, index) {
          
          // countDataã«document.data.countã‚’è¿½åŠ 
          pointData.push(document.data.point);
          
          // countDataã«document.data.countã‚’è¿½åŠ 
          countData.push(document.data.count);

          // imageUrlsã«document.data.imgã‚’è¿½åŠ 
          imageUrls.push(document.data.img);

        });

        //----------------------------------------
        // â–¼ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        //----------------------------------------
        const stampListContainer = document.getElementById('stampListContainer');

        function renderImages() {
            stampListContainer.innerHTML = '';          

            imageUrls.forEach((imageUrl, index) => {
              const imageWrapper = document.createElement('div');
              imageWrapper.className = 'image-wrapper';
              
              const imageElement = document.createElement('img');
              imageElement.src = imageUrl;
              imageElement.className = 'image';
              
              // ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«handleStampClické–¢æ•°ã‚’å‘¼ã³å‡ºã™
              // imageElement.addEventListener('click', () => handleItemClick(array[index].id));
              imageElement.addEventListener('click', () => {
                handleItemClick(array[index].id);
                imageElement.classList.add('clicked-image'); // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰ 'clicked-image' ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                setTimeout(() => {
                  imageElement.classList.remove('clicked-image'); // ä¸€å®šæ™‚é–“çµŒéå¾Œã« 'clicked-image' ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
                },2000); 
              });
              
              imageWrapper.appendChild(imageElement);
              
              const pointElement = document.createElement('div');
              pointElement.textContent = `${pointData[index]}`;
              pointElement.className = 'point';
              imageWrapper.appendChild(pointElement);
              
              stampListContainer.appendChild(imageWrapper);
            });
        }

        renderImages();
        
      // console.log("pointData", pointData);
      console.log("countData", countData);
      // console.log(imageUrls);
        
     
      });


      

    </script>
  </body>
</html>
